# Enclaver manifest â€” complete reference (v1)
#
# This file lists all supported configuration fields and documents ingress/egress rules.
# Copy, trim, and edit for your own service. Lines starting with `#` are comments.
#
# Contract
# - Inputs: Docker images, optional signing keys, optional TLS material inside the image.
# - Outputs: A release image that contains an EIF and the manifest; at runtime `odyn` reads this.
# - Errors: Unknown fields are rejected; missing required fields or malformed values fail at build/run.
#
# Notes
# - If `ingress` is omitted, there is no inbound connectivity into the enclave.
# - If `egress.allow` is empty or omitted, egress is entirely disabled and no proxy env vars are set.
# - If you enable `kms_proxy`, ensure egress allows IMDS (169.254.169.254) and your KMS endpoints.
# - Domain allow/deny rules support `*` (single label) and `**` (any suffix). See examples below.
# - IP allow/deny rules support exact IP and CIDR (IPv4/IPv6).
#
# ============================================================================
# Parameter Usage Legend:
#   [BUILD]   - Used by `enclaver build` CLI (build-time only)
#   [SLEEVE]  - Used by `enclaver-run` / Sleeve program (host-side runtime)
#   [ODYN]    - Used by Odyn supervisor (enclave-side runtime)
# ============================================================================

# Required top-level fields
version: "v1"                 # [BUILD] Schema version (string). Only "v1" is supported.
name: "your-service"          # [BUILD] Friendly name for your enclave/application (string).
target: "repo/name:tag"       # [BUILD] Release image tag to produce on build (string).

# Source images used during build
sources:
  app: "repo/app:tag"         # [BUILD] REQUIRED. The application image to run inside the enclave.
  # odyn and sleeve may be overridden. If omitted, well-known defaults are pulled.
  # Default odyn:   public.ecr.aws/d4t4u8d2/sparsity-ai/odyn:latest
  # Default sleeve: public.ecr.aws/d4t4u8d2/sparsity-ai/sleeve:latest
  #odyn: "repo/odyn:tag"      # [BUILD] Odyn supervisor image (binary is extracted and added to EIF).
  #sleeve: "repo/sleeve:tag"  # [BUILD] Sleeve base image (used as base for release image).

# Optional: sign the EIF at build time (keys are read on the host during build)
signature:
  # Paths are resolved relative to the manifest file location.
  certificate: ./path/to/cert.pem   # [BUILD] Required. Path to X.509 certificate in PEM format
  key: ./path/to/key.pem            # [BUILD] Required. Path to private key in PEM format

# Optional defaults used by `enclaver run` when flags are not provided
# If omitted, the runtime defaults are cpu_count=2, memory_mb=4096
defaults:
  cpu_count: 2               # [SLEEVE] Optional. Number of vCPUs (i32) to assign to the enclave
  memory_mb: 4096            # [SLEEVE] Optional. Enclave memory in MiB (i32)

# Ingress: host->enclave TCP/TLS listeners exposed by odyn inside the enclave
# Each entry binds inside the enclave on the given listen_port and is proxied via host localhost.
# At run time, the host-side runner publishes the same port to the host network as needed.
ingress:
  - listen_port: 18001       # aux API (for attestation)
  - listen_port: 8080        # [ODYN + SLEEVE] Required. TCP port (u16) inside the enclave.
                             # ODYN: binds EnclaveProxy on this port inside enclave.
                             # SLEEVE: binds HostProxy on host to forward to enclave vsock.
    # Optional TLS for the VSOCK leg (host<->enclave). The app still receives plain TCP on localhost.
    # Runtime expects PEM files at: <config_dir>/tls/server/<listen_port>/{cert.pem,key.pem}
    # By default odyn uses config_dir=/etc/enclaver inside the enclave.
    tls:
      key_file: key.pem      # [ODYN] Optional. TLS key file for ingress listener.
      cert_file: cert.pem    # [ODYN] Optional. TLS cert file for ingress listener.

  # Example (NOT for production): expose internal API, and Helios RPC externally.
  # WARNING: Do not expose these endpoints in production environments.
  # Production note: do NOT expose internal API or Helios RPC via ingress.
  # - listen_port: 18000       # internal API (full capabilities)
  # - listen_port: 8545        # Helios RPC

# Egress: enable a local HTTP(S) proxy inside the enclave with allow/deny policy
# When enabled, odyn sets http_proxy/https_proxy env vars to http://127.0.0.1:<proxy_port>
# and `no_proxy=localhost,127.0.0.1` for the entrypoint process.
egress:
  proxy_port: 10000          # [ODYN] Optional. TCP port (u16) for local egress proxy (default: 10000).
                             # ODYN: binds EnclaveHttpProxy on this port, sets http_proxy env var.
  # Allow and deny take a list of patterns. A request host is allowed iff it matches at least
  # one allow pattern AND does not match any deny pattern. If `allow` is empty/missing, egress is disabled.
  allow:
    # Domain patterns (case-insensitive):
    # - Multi-label suffix: "**.amazonaws.com" (matches s3.amazonaws.com and a.b.c.amazonaws.com)
    # NOTE: Domain patterns (including wildcards) DO NOT match IP addresses.
    # Use CIDR notation for IP filtering.
    # IP/CIDR patterns:
    # - Exact IP: "66.254.33.22" (implicit /32)
    # - IPv4 CIDR: "66.254.33.0/24"
    # - IPv6 CIDR: "::/0" (all IPv6)
    - "news.ycombinator.com" # [ODYN] Domain/IP patterns for egress allow list.
    #- "**"                   # Allow all domains (does not match IP addresses)
    #- "0.0.0.0/0"           # Allow all IPv4 traffic
    #- "::/0"                # Allow all IPv6 traffic
    #- "169.254.169.254"      # IMDS (needed if kms_proxy is enabled)
  deny:
    # Optional block list evaluated after allow. Same grammar as allow.
    #- "*.example.net"        # [ODYN] Domain/IP patterns for egress deny list.
    #- "10.0.0.0/8"

# Optional: local KMS-compatible proxy inside the enclave
# - Listens on HTTP and forwards to AWS KMS using IMDS-derived credentials via egress proxy.
# - Sets AWS_KMS_ENDPOINT=http://127.0.0.1:<listen_port> for the entrypoint process.
# - Requires egress.allow to include 169.254.169.254 (IMDS) and the KMS endpoints used.
kms_proxy:
  listen_port: 9000          # [ODYN] Required. TCP port (u16) for local KMS proxy.
                             # ODYN: binds KmsProxyService, sets AWS_KMS_ENDPOINT env var.
  # Optional per-region endpoint overrides (value is host only; scheme/path are set by the proxy)
  # If omitted, defaults to kms.<region>.amazonaws.com
  endpoints:                 # [ODYN] Optional. Map of region name to KMS endpoint hostname.
    us-east-1: kms.us-east-1.amazonaws.com
    #eu-west-1: kms.eu-west-1.amazonaws.com

# Optional: internal API exposed inside the enclave for attestation/encryption/signing
api:
  listen_port: 18000         # [ODYN] Required. TCP port (u16) for internal API server.
                             # ODYN: binds ApiService providing /v1/attestation, /v1/eth/*, etc.

# Optional: auxiliary API for restricted external access (e.g., sidecars)
# If not specified, defaults to api.listen_port + 1 when api is configured.
aux_api:
  listen_port: 18001         # [ODYN] Optional. TCP port (u16) for auxiliary API server.
                             # ODYN: binds AuxApiService with sanitized attestation endpoint.

# Optional: Helios Ethereum/OP Stack light client RPC (trustless JSON-RPC)
helios_rpc:
  enabled: false             # [ODYN] Optional. Enable/disable Helios RPC service.
  kind: ethereum             # [ODYN] Required. Client type: "ethereum" or "opstack".
  listen_port: 8545          # [ODYN] Optional. TCP port (u16) for Helios JSON-RPC (default: 8545).
  # Network name (required when enabled):
  #   ethereum: mainnet, sepolia, holesky
  #   opstack:  op-mainnet, base, base-sepolia, worldchain, zora, unichain
  network: mainnet           # [ODYN] Required when enabled.
  execution_rpc: "https://eth-mainnet.g.alchemy.com/v2/YOUR_API_KEY" # [ODYN] Required when enabled.
  #consensus_rpc: "https://www.lightclientdata.org" # [ODYN] Optional. Consensus RPC URL (ethereum only).
  #checkpoint: "0x..."       # [ODYN] Optional. Weak subjectivity checkpoint (ethereum only).

# Optional: S3 storage configuration for persistent data
storage:
  s3:
    enabled: true            # [ODYN] Whether to enable S3 storage integration.
    bucket: "my-app-data"    # [ODYN] S3 bucket name for storage.
    prefix: "apps/my-service/" # [ODYN] Key prefix for isolation. If it doesn't end with '/', it will be added.
    region: "us-east-1"      # [ODYN] Optional. AWS region override for the bucket.
                             # If omitted, the region is resolved via IMDS.
                             # Requires egress allow for IMDS (169.254.169.254) and the S3 endpoint.

# ============================================================================
# Summary: Parameter -> Module Mapping
# ============================================================================
#
# | Parameter              | Module      | Description                                    |
# |------------------------|-------------|------------------------------------------------|
# | version                | BUILD       | Manifest schema version                        |
# | name                   | BUILD       | Application name for tagging                   |
# | target                 | BUILD       | Output release image tag                       |
# | sources.app            | BUILD       | User application Docker image                  |
# | sources.odyn           | BUILD       | Odyn supervisor image (binary extraction)      |
# | sources.sleeve         | BUILD       | Sleeve base image for release packaging        |
# | signature.certificate  | BUILD       | EIF signing certificate path                   |
# | signature.key          | BUILD       | EIF signing private key path                   |
# | defaults.cpu_count     | SLEEVE      | Enclave vCPU allocation                        |
# | defaults.memory_mb     | SLEEVE      | Enclave memory allocation                      |
# | ingress[].listen_port  | ODYN+SLEEVE | Ingress port (both sides bind proxies)         |
# | ingress[].tls.*        | ODYN        | TLS configuration for ingress                  |
# | egress.proxy_port      | ODYN        | Local HTTP proxy port inside enclave           |
# | egress.allow           | ODYN        | Egress allow list (domain/IP patterns)         |
# | egress.deny            | ODYN        | Egress deny list (domain/IP patterns)          |
# | kms_proxy.listen_port  | ODYN        | Local KMS proxy port inside enclave            |
# | kms_proxy.endpoints    | ODYN        | Regional KMS endpoint overrides                |
# | api.listen_port        | ODYN        | Internal API port (attestation, signing, etc.) |
# | aux_api.listen_port    | ODYN        | Auxiliary API port (restricted access)         |
# | helios_rpc.enabled     | ODYN        | Enable/disable Helios RPC service              |
# | helios_rpc.kind        | ODYN        | Helios client type (ethereum or opstack)       |
# | helios_rpc.listen_port | ODYN        | Helios JSON-RPC port inside enclave            |
# | helios_rpc.network     | ODYN        | Helios network selection                       |
# | helios_rpc.execution_rpc | ODYN      | Execution RPC URL (untrusted, required)        |
# | helios_rpc.consensus_rpc | ODYN      | Consensus RPC URL override                     |
# | helios_rpc.checkpoint  | ODYN        | Weak subjectivity checkpoint override          |
# | storage.s3.enabled     | ODYN        | Enable/disable S3 storage integration          |
# | storage.s3.bucket      | ODYN        | S3 bucket for persistent storage               |
# | storage.s3.prefix      | ODYN        | Prefix for S3 key isolation                    |
# | storage.s3.region      | ODYN        | Regional override for S3 bucket                |
#
# ============================================================================
